[
    {
        "name": "open new upstreamable PR",
        "payload": "new_pr.json",
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_18746",
            "OpenPRStep:servo-wpt-sync/wpt/servo_export_18746→wpt/wpt#1",
            "CommentStep:servo/servo#18746:Found upstreamable WPT changes. Opened new upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "open new upstreamable PR with move into wpt",
        "payload": "new_pr.json",
        "diff": "move-into-wpt.diff",
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_18746",
            "OpenPRStep:servo-wpt-sync/wpt/servo_export_18746→wpt/wpt#1",
            "CommentStep:servo/servo#18746:Found upstreamable WPT changes. Opened new upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "open new upstreamable PR with move into wpt, non-ascii author",
        "payload": "new_pr.json",
        "diff": [["move-into-wpt.diff", "Fernando Jiménez Moreno", "foo@bar.com", "ééééé"]],
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_18746",
            "OpenPRStep:servo-wpt-sync/wpt/servo_export_18746→wpt/wpt#1",
            "CommentStep:servo/servo#18746:Found upstreamable WPT changes. Opened new upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "open new upstreamable PR with move out of wpt",
        "payload": "new_pr.json",
        "diff": "move-out-of-wpt.diff",
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_18746",
            "OpenPRStep:servo-wpt-sync/wpt/servo_export_18746→wpt/wpt#1",
            "CommentStep:servo/servo#18746:Found upstreamable WPT changes. Opened new upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "open new upstreamable PR, no-sync",
        "payload": "new_pr_no_sync.json",
        "existing_prs": {},
        "expected": []
    },
    {
        "name": "open new non-upstreamable PR, no-sync",
        "payload": "new_pr_no_sync.json",
        "diff": "non-wpt.diff",
        "existing_prs": {},
        "expected": []
    },
    {
        "name": "open new upstreamable PR which doesn't apply",
        "payload": "new_pr.json",
        "diff": "new_pr_patch_does_not_apply.diff",
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep",
            "CommentStep:servo/servo#18746:These changes could not be applied onto the latest\n upstream web-platform-tests. Servo may be out of sync."
        ]
    },
    {
        "name": "open existing upstreamable PR",
        "payload": "new_pr.json",
        "existing_prs": {"servo_export_18746": 1},
        "expected": [
            "ChangePRStep:wpt/wpt#1:opened:This is a test",
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_18746",
            "CommentStep:servo/servo#18746:Transplanted upstreamable changes to existing upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "open existing non-upstreamable PR",
        "payload": "new_pr.json",
        "diff": "non-wpt.diff",
        "existing_prs": {"servo_export_18746": 1},
        "expected": [
            "CommentStep:wpt/wpt#1:Downstream PR (servo/servo#18746) no longer contains any upstreamable changes. Closing PR.",
            "ChangePRStep:wpt/wpt#1:closed",
            "RemoveBranchForPRStep",
            "CommentStep:servo/servo#18746:No upstreamable changes; closed existing upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "open existing PR; patch doesn't apply",
        "payload": "new_pr.json",
        "diff": "new_pr_patch_does_not_apply.diff",
        "existing_prs": {"servo_export_18746": 1},
        "expected": [
            "ChangePRStep:wpt/wpt#1:opened:This is a test",
            "CreateOrUpdateBranchForPRStep",
            "CommentStep:servo/servo#18746:These changes could not be applied onto the latest\n upstream web-platform-tests. Servo may be out of sync.",
            "CommentStep:wpt/wpt#1:The downstream PR (servo/servo#18746) can no longer be applied.\n Waiting for a new version of these changes downstream."
        ]
    },
    {
        "name": "close non-upstreamable PR",
        "payload": "close_pr.json",
        "existing_prs": {},
        "expected": []
    },
    {
        "name": "close upstreamable PR",
        "payload": "close_pr.json",
        "existing_prs": {"servo_export_18746": 10},
        "expected": [
            "ChangePRStep:wpt/wpt#10:closed",
            "RemoveBranchForPRStep"
        ]
    },
    {
        "name": "synchronize upstreamable PR",
        "payload": "synchronize.json",
        "diff": "18746.diff",
        "existing_prs": {"servo_export_19612": 10},
        "expected": [
            "ChangePRStep:wpt/wpt#10:opened:deny warnings",
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_19612",
            "CommentStep:servo/servo#19612:Transplanted upstreamable changes to existing upstream PR (wpt/wpt#10)."
        ]
    },
    {
        "name": "synchronize newly non-upstreamable PR",
        "payload": "synchronize.json",
        "diff": "non-wpt.diff",
        "existing_prs": {"servo_export_19612": 11},
        "expected": [
            "CommentStep:wpt/wpt#11:Downstream PR (servo/servo#19612) no longer contains any upstreamable changes. Closing PR.",
            "ChangePRStep:wpt/wpt#11:closed",
            "RemoveBranchForPRStep",
            "CommentStep:servo/servo#19612:No upstreamable changes; closed existing upstream PR (wpt/wpt#11)."
        ]
    },
    {
        "name": "synchronize newly upstreamable PR",
        "payload": "synchronize.json",
        "diff": "18746.diff",
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep:1:servo-wpt-sync/wpt/servo_export_19612",
            "OpenPRStep:servo-wpt-sync/wpt/servo_export_19612→wpt/wpt#1",
            "CommentStep:servo/servo#19612:Found upstreamable WPT changes. Opened new upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "synchronize newly upstreamable PR; patch doesn't apply",
        "payload": "synchronize.json",
        "diff": "new_pr_patch_does_not_apply.diff",
        "existing_prs": {"servo_export_19612": 11},
        "expected": [
            "ChangePRStep:wpt/wpt#11:opened:deny warnings",
            "CreateOrUpdateBranchForPRStep",
            "CommentStep:servo/servo#19612:These changes could not be applied onto the latest\n upstream web-platform-tests. Servo may be out of sync.",
            "CommentStep:wpt/wpt#11:The downstream PR (servo/servo#19612) can no longer be applied.\n Waiting for a new version of these changes downstream."
        ]
    },
    {
        "name": "synchronize new upstreamable PR multiple commits",
        "payload": "synchronize-multiple.json",
        "diff": ["18746.diff", "non-wpt.diff", "wpt.diff"],
        "existing_prs": {},
        "expected": [
            "CreateOrUpdateBranchForPRStep:2:servo-wpt-sync/wpt/servo_export_19612",
            "OpenPRStep:servo-wpt-sync/wpt/servo_export_19612→wpt/wpt#1",
            "CommentStep:servo/servo#19612:Found upstreamable WPT changes. Opened new upstream PR (wpt/wpt#1)."
        ]
    },
    {
        "name": "synchronize non-upstreamable PR",
        "payload": "synchronize.json",
        "diff": "non-wpt.diff",
        "existing_prs": {},
        "expected": []
    },
    {
        "name": "merge upstreamed PR",
        "payload": "merged.json",
        "diff": "18746.diff",
        "existing_prs": {"servo_export_19620": 100},
        "expected": [
            "MergePRStep:wpt/wpt#100"
        ]
    },
    {
        "name": "merge non-upstreamed PR",
        "payload": "merged.json",
        "diff": "non-wpt.diff",
        "existing_prs": {},
        "expected": []
    }
]
